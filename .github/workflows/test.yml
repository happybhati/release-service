name: Test SMTP Connectivity

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of SMTP test to run'
        required: true
        default: 'no-auth'
        type: choice
        options:
        - no-auth
        - with-auth

jobs:
  test-smtp:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Test network connectivity to Red Hat SMTP
        run: |
          echo "🔍 Testing network connectivity to smtp.corp.redhat.com..."
          nc -zv smtp.corp.redhat.com 25 2>&1 || echo "❌ Cannot reach smtp.corp.redhat.com:25"
          nc -zv smtp.corp.redhat.com 587 2>&1 || echo "❌ Cannot reach smtp.corp.redhat.com:587"
          
          echo "🔍 Testing connectivity to Gmail SMTP..."
          nc -zv smtp.gmail.com 587 2>&1 || echo "❌ Cannot reach smtp.gmail.com:587"

      - name: Create SMTP test script
        run: |
          cat > test_smtp_github.py << 'EOF'
          #!/usr/bin/env python3
          import smtplib
          import os
          import sys
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart

          def test_smtp_no_auth():
              """Test SMTP without authentication (Red Hat corporate)"""
              try:
                  print("🔧 Testing Red Hat SMTP without authentication...")
                  
                  msg = MIMEMultipart()
                  msg['From'] = 'konflux-release-team@redhat.com'
                  msg['To'] = 'hbhati@redhat.com'
                  msg['Subject'] = 'GitHub Actions SMTP Test - No Auth'
                  
                  body = "This is a test email from GitHub Actions using Red Hat SMTP without authentication."
                  msg.attach(MIMEText(body, 'plain'))
                  
                  with smtplib.SMTP('smtp.corp.redhat.com', 25) as server:
                      print("📡 Connected to smtp.corp.redhat.com:25")
                      server.send_message(msg)
                      print("✅ Email sent successfully without authentication!")
                      return True
                      
              except Exception as e:
                  print(f"❌ No-auth SMTP failed: {e}")
                  return False

          def test_smtp_with_auth():
              """Test SMTP with authentication"""
              username = os.getenv('SMTP_USERNAME')
              password = os.getenv('SMTP_PASSWORD')
              
              if not username or not password:
                  print("⚠️ SMTP credentials not provided, skipping auth test")
                  return False
                  
              try:
                  print("🔧 Testing SMTP with authentication...")
                  
                  msg = MIMEMultipart()
                  msg['From'] = username
                  msg['To'] = 'hbhati@redhat.com'
                  msg['Subject'] = 'GitHub Actions SMTP Test - With Auth'
                  
                  body = "This is a test email from GitHub Actions using SMTP with authentication."
                  msg.attach(MIMEText(body, 'plain'))
                  
                  # Try Google Workspace SMTP first, then regular Gmail
                  servers_to_try = [
                      ('smtp.googlemail.com', 587, 'Google Workspace'),
                      ('smtp.gmail.com', 587, 'Gmail'),
                      ('smtp.gmail.com', 465, 'Gmail SSL')
                  ]
                  
                  for smtp_server, port, name in servers_to_try:
                      try:
                          print(f"📡 Trying {name}: {smtp_server}:{port}")
                          with smtplib.SMTP(smtp_server, port) as server:
                              if port == 465:
                                  server.starttls()
                              else:
                                  server.starttls()
                              server.login(username, password)
                              server.send_message(msg)
                              print(f"✅ Email sent successfully via {name}!")
                              return True
                      except Exception as e:
                          print(f"❌ {name} failed: {e}")
                          continue
                  
                  print("❌ All SMTP servers failed")
                  return False
                      
              except Exception as e:
                  print(f"❌ Auth SMTP failed: {e}")
                  return False

          if __name__ == "__main__":
              test_type = sys.argv[1] if len(sys.argv) > 1 else 'no-auth'
              
              if test_type == 'no-auth':
                  success = test_smtp_no_auth()
              else:
                  success = test_smtp_with_auth()
              
              sys.exit(0 if success else 1)
          EOF

      - name: Run SMTP test (No Authentication)
        if: inputs.test_type == 'no-auth'
        run: python test_smtp_github.py no-auth

      - name: Run SMTP test (With Authentication)
        if: inputs.test_type == 'with-auth'
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: python test_smtp_github.py with-auth

      - name: Test summary
        run: |
          echo "🎯 SMTP Test Summary:"
          echo "  - Test Type: ${{ inputs.test_type }}"
          echo "  - Check your email (hbhati@redhat.com) for test messages"
          echo "  - If tests fail, we'll need to use authenticated SMTP for GitHub Actions"
